<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员系统</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/tech.css">
</head>
<body>
    <div class="floating-bg" aria-hidden="true"></div>
    <div class="page-hero" aria-hidden="false">
        <h1 class="hero-title">管理员系统</h1>
        <p class="hero-sub">用户管理面板</p>
    </div>
    <div class="container">
        <div class="header" aria-hidden="true">
            <div>
                <button class="btn add-user-btn" id="addUserBtn">添加用户</button>
                <button class="btn logout-btn" id="logoutBtn">退出登录</button>
            </div>
        </div>

        <div class="content">
            <div class="message error-message" id="errorMessage"></div>
            <div class="message success-message" id="successMessage"></div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>加载中...</p>
            </div>

            <table class="users-table" id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>用户名</th>
                        <th>密码</th>
                        <th>用户类型</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- 用户数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 添加/编辑用户模态框 -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">添加用户</h2>
                <span class="close">&times;</span>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <div class="field">
                        <select id="userType" name="userType" required>
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                        </select>
                        <label for="userType">用户类型</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="field">
                        <input type="text" id="username" name="username" required placeholder=" ">
                        <label for="username">用户名</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="field">
                        <input type="number" id="age" name="age" required min="1" max="150" placeholder=" ">
                        <label for="age">年龄</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="field">
                        <input type="tel" id="phone" name="phone" required placeholder=" ">
                        <label for="phone">手机号</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="field">
                        <input type="password" id="password" name="password" required placeholder=" ">
                        <label for="password">密码</label>
                    </div>
                </div>
                <!-- 在表单中添加消息显示区域 -->
                <div class="message error-message" id="modalErrorMessage"></div>
                <div class="message success-message" id="modalSuccessMessage"></div>
                <div class="form-actions">
                    <button type="button" class="btn cancel-btn">取消</button>
                    <button type="submit" class="btn save-btn">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // DOM 元素
        const usersTableBody = document.getElementById('usersTableBody');
        const userModal = document.getElementById('userModal');
        const modalTitle = document.getElementById('modalTitle');
        const userForm = document.getElementById('userForm');
        const userIdInput = document.getElementById('userId');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const addUserBtn = document.getElementById('addUserBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.querySelector('.cancel-btn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        // 添加模态框内的消息元素引用
        const modalErrorMessage = document.getElementById('modalErrorMessage');
        const modalSuccessMessage = document.getElementById('modalSuccessMessage');

        // 当前编辑的用户ID
        let currentEditUserId = null;

        // 页面加载完成后获取用户列表
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });

        // 加载用户列表
        function loadUsers() {
            showLoading(true);
            hideMessage();

            // 实际API调用示例:
            fetch('/admin/users/', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + getAuthToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    renderUsers(data.data);
                } else {
                    showMessage(data.msg, 'error');
                }
                showLoading(false);
            })
            .catch(error => {
                showMessage('获取用户列表失败: ' + error.message, 'error');
                showLoading(false);
                console.error('Error:', error);
            });

        }

        // 渲染用户列表
 // 修改renderUsers函数，适配字符串类型的用户类型字段
function renderUsers(users) {
    usersTableBody.innerHTML = '';

    if (users.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" class="no-data">暂无用户数据</td>';
        usersTableBody.appendChild(row);
        return;
    }

    users.forEach(user => {
        // 根据用户类型显示不同的文本
        const userTypeText = user.user_type === 'admin' ? '管理员' : '普通用户';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>******</td>
            <td>${userTypeText}</td>
            <td>
                <button class="action-btn edit-btn" data-id="${user.id}">编辑</button>
                <button class="action-btn delete-btn" data-id="${user.id}">删除</button>
            </td>
        `;
        usersTableBody.appendChild(row);
    });

    // 绑定编辑和删除按钮事件
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = parseInt(this.getAttribute('data-id'));
            editUser(userId);
        });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = parseInt(this.getAttribute('data-id'));
            deleteUser(userId);
        });
    });
}



        // 添加用户按钮事件
        addUserBtn.addEventListener('click', function() {
            currentEditUserId = null;
            modalTitle.textContent = '添加用户';
            userForm.reset();
            userIdInput.value = '';
            userModal.style.display = 'flex';
        });

        // 编辑用户

        // 编辑用户
// 修改editUser函数，适配字符串类型的用户类型字段
function editUser(userId) {
    fetch(`/admin/users/${userId}/`, {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getAuthToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            currentEditUserId = userId;
            modalTitle.textContent = '编辑用户';
            userIdInput.value = data.data.id;
            usernameInput.value = data.data.username;
            document.getElementById('age').value = data.data.age;
            document.getElementById('phone').value = data.data.phone;
            // 设置用户类型（适配字符串类型）
            document.getElementById('userType').value = data.data.user_type || 'user';
            passwordInput.value = '';
            userModal.style.display = 'flex';
        } else {
            showMessage(data.msg, 'error');
        }
    })
    .catch(error => {
        showMessage('获取用户信息失败: ' + error.message, 'error');
        console.error('Error:', error);
    });
}




        // 删除用户

function deleteUser(userId) {
    if (!confirm('确定要删除该用户吗？')) {
        return;
    }

    showLoading(true);

    fetch(`/admin/users/${userId}/delete/`, {
        method: 'DELETE',
        headers: {
            'Authorization': 'Bearer ' + getAuthToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        console.log('Delete response:', data); // 添加调试信息
        if (data.code === 200) {
            console.log('Showing success message'); // 添加调试信息
            loadUsers(); // 重新加载用户列表
            showMessage('用户删除成功', 'success');
        } else {
            console.log('Showing error message'); // 添加调试信息
            showMessage(data.msg, 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        console.log('Showing error message for exception'); // 添加调试信息
        showMessage('删除用户失败: ' + error.message, 'error');
        console.error('Error:', error);
    });
}




      // 修改表单提交事件处理函数
userForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const username = usernameInput.value.trim();
    const age = document.getElementById('age').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const password = passwordInput.value;
    // 获取用户类型值
    const userType = document.getElementById('userType').value;

    if (username === '' || password === '' || age === '' || phone === '') {
        showMessage('所有字段都不能为空', 'error', 'modal');
        return;
    }

    // 验证手机号格式
    if (!/^1[3-9]\d{9}$/.test(phone)) {
        showMessage('请输入正确的手机号格式', 'error', 'modal');
        return;
    }

    // 验证年龄
    const ageNum = parseInt(age);
    if (isNaN(ageNum) || ageNum < 1 || ageNum > 150) {
        showMessage('年龄必须在1-150之间', 'error', 'modal');
        return;
    }

    showLoading(true);
    hideMessage();

    const userData = {
        username,
        password,
        age: parseInt(age),
        phone,
        user_type: userType  // 直接使用字符串类型
    };

    if (currentEditUserId) {
        // 更新用户
        fetch(`/admin/users/${currentEditUserId}/`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + getAuthToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.code === 200) {
                showMessage(data.msg, 'success', 'modal');
                // 延迟关闭模态框并刷新用户列表
                setTimeout(() => {
                    userModal.style.display = 'none';
                    loadUsers();
                }, 1500);
            } else {
                showMessage(data.msg, 'error', 'modal');
            }
        })
        .catch(error => {
            showLoading(false);
            showMessage('更新用户失败: ' + error.message, 'error', 'modal');
            console.error('Error:', error);
        });
    } else {
        // 添加用户
        fetch('/admin/user_add/', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getAuthToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.code === 200) {
                showMessage('用户添加成功', 'success', 'modal');
                // 延迟关闭模态框并刷新用户列表
                setTimeout(() => {
                    userModal.style.display = 'none';
                    loadUsers();
                }, 1500);
            } else {
                showMessage(data.msg, 'error', 'modal');
            }
        })
        .catch(error => {
            showLoading(false);
            showMessage('添加用户失败: ' + error.message, 'error', 'modal');
            console.error('Error:', error);
        });
    }
});


        // 关闭模态框
        function closeModal() {
            userModal.style.display = 'none';
        }

        // 绑定关闭事件
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        window.addEventListener('click', function(event) {
            if (event.target === userModal) {
                closeModal();
            }
        });

        // 退出登录
        logoutBtn.addEventListener('click', function() {
            if (confirm('确定要退出登录吗？')) {
                // 清除用户信息
                localStorage.removeItem('user_info');
                // 跳转到登录页面
                window.location.href = 'login.html';
            }
        });

        // 显示/隐藏加载状态
        function showLoading(show) {
            if (show) {
                loading.style.display = 'block';
            } else {
                loading.style.display = 'none';
            }
        }

        // 显示消息 - 修改后的函数，添加target参数
        function showMessage(message, type, target = 'main') {
            if (target === 'modal') {
                // 隐藏模态框内的所有消息
                modalErrorMessage.style.display = 'none';
                modalSuccessMessage.style.display = 'none';

                // 显示对应消息
                if (type === 'error') {
                    modalErrorMessage.textContent = message;
                    modalErrorMessage.style.display = 'block';
                } else {
                    modalSuccessMessage.textContent = message;
                    modalSuccessMessage.style.display = 'block';
                }

                // 3秒后自动隐藏消息
                setTimeout(() => {
                    modalErrorMessage.style.display = 'none';
                    modalSuccessMessage.style.display = 'none';
                }, 1500);
            } else {
                // 原有的主页面消息显示逻辑
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';

                if (type === 'error') {
                    errorMessage.textContent = message;
                    errorMessage.style.display = 'block';
                } else {
                    successMessage.textContent = message;
                    successMessage.style.display = 'block';
                }

                // 3秒后自动隐藏消息
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                    successMessage.style.display = 'none';
                }, 1500);
            }
        }

        // 隐藏所有消息
        function hideMessage() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // 获取认证token的辅助函数（示例）
        function getAuthToken() {
            const userInfo = localStorage.getItem('user_info');
            if (userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    return user.token || '';
                } catch (e) {
                    return '';
                }
            }
            return '';
        }
    </script>
</body>
</html>
